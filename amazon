#!/usr/bin/python
#
# TODO:
#   -offer root
#   -<= good condition
#   -parse offer
#   -parse shipping
#   -calculate total
#   -SMS notify
#

import StringIO,httplib,lxml.html,re

BOOKID='1841499897'
SERVER={'EUR':'www.amazon.de','GBP':'www.amazon.co.uk'}

#----------------------------

def currency(curr):
    try:
        c = httplib.HTTPConnection('www.cnb.cz',timeout=15)
        c.request('GET','/cs/financni_trhy/devizovy_trh/kurzy_devizoveho_trhu/denni_kurz.txt')
        r = c.getresponse()
        if r.status == 200:
            for LINE in r.read().split('\n'):
                if curr in LINE:
                    value = float(re.sub(',','.',re.sub('.*\|(.*)$','\\1',LINE)))
        c.close()
        return value
    except: pass
    return ''

def clean_price(curr,val):
    if curr == 'GBP':
        return float(re.sub('\xa3','',val.strip()))# Pound char
    if curr == 'EUR':
        return float(re.sub(',','.',re.sub('EUR ','',val.strip())))# 'EUR ' + decimal

def parse_offer(curr):
    c = httplib.HTTPSConnection(SERVER[curr],'443',timeout=15)
    c.request('GET','/gp/offer-listing/' + BOOKID + '/')
    r = c.getresponse()
    if r.status == 200:
        p = lxml.html.HTMLParser()
        t = lxml.html.parse(StringIO.StringIO(r.read()),p)
        o = t.xpath("//div[contains(@class,'olpOffer')]")
        for i in range(1,len(o)):
            price = o[i].xpath(".//span[contains(@class,'olpOfferPrice')]")
            shipping = o[i].xpath(".//span[contains(@class,'olpShippingPrice')]")
            if p: print clean_price(curr,price[0].text)
            if d: print clean_price(curr,shipping[0].text)
    c.close()
    return

#----------------------------

